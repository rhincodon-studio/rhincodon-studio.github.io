"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7186],{8453:(e,r,n)=>{n.d(r,{R:()=>c,x:()=>t});var l=n(6540);const s={},d=l.createContext(s);function c(e){const r=l.useContext(d);return l.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function t(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),l.createElement(d.Provider,{value:r},e.children)}},8771:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>i,contentTitle:()=>t,default:()=>h,frontMatter:()=>c,metadata:()=>l,toc:()=>a});const l=JSON.parse('{"id":"kubernetes-rke2/rke2-ha-full","title":"RKE2 \u9ad8\u53ef\u7528\uff08HA\uff09\u67b6\u69cb\u90e8\u7f72\u6307\u5357","description":"1. \u67b6\u69cb\u8aaa\u660e","source":"@site/docs/kubernetes-rke2/2.rke2-ha-full.md","sourceDirName":"kubernetes-rke2","slug":"/kubernetes-rke2/rke2-ha-full","permalink":"/docs/kubernetes-rke2/rke2-ha-full","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/kubernetes-rke2/2.rke2-ha-full.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"id":"rke2-ha-full","title":"RKE2 \u9ad8\u53ef\u7528\uff08HA\uff09\u67b6\u69cb\u90e8\u7f72\u6307\u5357","sidebar_label":"RKE2 \u9ad8\u53ef\u7528\u53e2\u96c6\uff08HA\uff09"},"sidebar":"tutorialSidebar","previous":{"title":"RKE2 \u5feb\u901f\u4e0a\u624b","permalink":"/docs/kubernetes-rke2/rke2-quickstart-full"},"next":{"title":"Troubleshooting\uff081\uff09etcd / \u8a18\u61b6\u9ad4","permalink":"/docs/kubernetes-rke2/rke2-troubleshooting-1"}}');var s=n(4848),d=n(8453);const c={id:"rke2-ha-full",title:"RKE2 \u9ad8\u53ef\u7528\uff08HA\uff09\u67b6\u69cb\u90e8\u7f72\u6307\u5357",sidebar_label:"RKE2 \u9ad8\u53ef\u7528\u53e2\u96c6\uff08HA\uff09"},t="RKE2 \u9ad8\u53ef\u7528\u53e2\u96c6\uff08HA\uff09",i={},a=[{value:"1. \u67b6\u69cb\u8aaa\u660e",id:"1-\u67b6\u69cb\u8aaa\u660e",level:2},{value:"\u7bc4\u4f8b\u62d3\u64b2",id:"\u7bc4\u4f8b\u62d3\u64b2",level:3},{value:"Load Balancer \u9700\u8981\u8f49\u767c\uff1a",id:"load-balancer-\u9700\u8981\u8f49\u767c",level:3},{value:"2. \u5b89\u88dd Control Plane\uff08\u6bcf\u53f0 Server \u90fd\u8981\u57f7\u884c\uff09",id:"2-\u5b89\u88dd-control-plane\u6bcf\u53f0-server-\u90fd\u8981\u57f7\u884c",level:2},{value:"2.1 \u5b89\u88dd RKE2",id:"21-\u5b89\u88dd-rke2",level:3},{value:"2.2 \u5efa\u7acb Control Plane \u8a2d\u5b9a\u6a94",id:"22-\u5efa\u7acb-control-plane-\u8a2d\u5b9a\u6a94",level:3},{value:"2.3 \u555f\u52d5 RKE2 Server",id:"23-\u555f\u52d5-rke2-server",level:3},{value:"3. \u5b89\u88dd Worker Nodes",id:"3-\u5b89\u88dd-worker-nodes",level:2},{value:"3.1 \u5b89\u88dd Agent",id:"31-\u5b89\u88dd-agent",level:3},{value:"3.2 \u5efa\u7acb Worker \u8a2d\u5b9a\u6a94",id:"32-\u5efa\u7acb-worker-\u8a2d\u5b9a\u6a94",level:3},{value:"3.3 \u555f\u52d5 agent",id:"33-\u555f\u52d5-agent",level:3},{value:"4. Load Balancer\uff08HAProxy / Keepalived\uff09",id:"4-load-balancerhaproxy--keepalived",level:2},{value:"4.1 Keepalived\uff08\u63d0\u4f9b VIP\uff09",id:"41-keepalived\u63d0\u4f9b-vip",level:3},{value:"4.2 HAProxy\uff08\u8f49\u767c 6443 / 9345\uff09",id:"42-haproxy\u8f49\u767c-6443--9345",level:3},{value:"5. \u9a57\u8b49\u53e2\u96c6\u72c0\u614b",id:"5-\u9a57\u8b49\u53e2\u96c6\u72c0\u614b",level:2},{value:"5.1 \u6aa2\u67e5\u7bc0\u9ede",id:"51-\u6aa2\u67e5\u7bc0\u9ede",level:3},{value:"5.2 \u6aa2\u67e5\u6240\u6709 Pod",id:"52-\u6aa2\u67e5\u6240\u6709-pod",level:3},{value:"5.3 \u6aa2\u67e5 etcd \u6210\u54e1",id:"53-\u6aa2\u67e5-etcd-\u6210\u54e1",level:3},{value:"6. Troubleshooting\uff08\u5e38\u898b\u554f\u984c\u6392\u67e5\uff09",id:"6-troubleshooting\u5e38\u898b\u554f\u984c\u6392\u67e5",level:2},{value:"\u554f\u984c 1\uff1a<code>connection refused 127.0.0.1:2379</code>",id:"\u554f\u984c-1connection-refused-1270012379",level:3},{value:"\u554f\u984c 2\uff1a<code>x509: certificate is valid for ... not VIP</code>",id:"\u554f\u984c-2x509-certificate-is-valid-for--not-vip",level:3},{value:"\u554f\u984c 3\uff1aWorker \u7121\u6cd5\u52a0\u5165",id:"\u554f\u984c-3worker-\u7121\u6cd5\u52a0\u5165",level:3},{value:"\u554f\u984c 4\uff1aetcd quorum lost",id:"\u554f\u984c-4etcd-quorum-lost",level:3}];function o(e){const r={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"rke2-\u9ad8\u53ef\u7528\u53e2\u96c6ha",children:"RKE2 \u9ad8\u53ef\u7528\u53e2\u96c6\uff08HA\uff09"})}),"\n",(0,s.jsx)(r.h2,{id:"1-\u67b6\u69cb\u8aaa\u660e",children:"1. \u67b6\u69cb\u8aaa\u660e"}),"\n",(0,s.jsxs)(r.p,{children:["RKE2 \u5b98\u65b9\u5efa\u8b70\u7684\u9ad8\u53ef\u7528\u67b6\u69cb\u81f3\u5c11\u9700\u8981 ",(0,s.jsx)(r.strong,{children:"3 \u53f0 Control Plane\uff08\u542b etcd\uff09"})," \u642d\u914d VIP / LoadBalancer\u3002"]}),"\n",(0,s.jsx)(r.h3,{id:"\u7bc4\u4f8b\u62d3\u64b2",children:"\u7bc4\u4f8b\u62d3\u64b2"}),"\n",(0,s.jsxs)(r.table,{children:[(0,s.jsx)(r.thead,{children:(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.th,{children:"\u7bc0\u9ede"}),(0,s.jsx)(r.th,{children:"\u89d2\u8272"}),(0,s.jsx)(r.th,{children:"IP"})]})}),(0,s.jsxs)(r.tbody,{children:[(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"cp-1"}),(0,s.jsx)(r.td,{children:"control-plane + etcd"}),(0,s.jsx)(r.td,{children:"192.168.1.10"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"cp-2"}),(0,s.jsx)(r.td,{children:"control-plane + etcd"}),(0,s.jsx)(r.td,{children:"192.168.1.20"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"cp-3"}),(0,s.jsx)(r.td,{children:"control-plane + etcd"}),(0,s.jsx)(r.td,{children:"192.168.1.30"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"worker-1"}),(0,s.jsx)(r.td,{children:"worker"}),(0,s.jsx)(r.td,{children:"192.168.1.40"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"VIP"}),(0,s.jsx)(r.td,{children:"\u865b\u64ec IP"}),(0,s.jsx)(r.td,{children:"192.168.1.100"})]})]})]}),"\n",(0,s.jsx)(r.h3,{id:"load-balancer-\u9700\u8981\u8f49\u767c",children:"Load Balancer \u9700\u8981\u8f49\u767c\uff1a"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"6443 \u2192 Kubernetes API"}),"\n",(0,s.jsx)(r.li,{children:"9345 \u2192 RKE2 Supervisor"}),"\n"]}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"2-\u5b89\u88dd-control-plane\u6bcf\u53f0-server-\u90fd\u8981\u57f7\u884c",children:"2. \u5b89\u88dd Control Plane\uff08\u6bcf\u53f0 Server \u90fd\u8981\u57f7\u884c\uff09"}),"\n",(0,s.jsx)(r.h3,{id:"21-\u5b89\u88dd-rke2",children:"2.1 \u5b89\u88dd RKE2"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"curl -sL https://get.rke2.io | INSTALL_RKE2_VERSION=v1.27.12+rke2r1 sh\n"})}),"\n",(0,s.jsx)(r.h3,{id:"22-\u5efa\u7acb-control-plane-\u8a2d\u5b9a\u6a94",children:"2.2 \u5efa\u7acb Control Plane \u8a2d\u5b9a\u6a94"}),"\n",(0,s.jsxs)(r.p,{children:["\u8def\u5f91\uff1a",(0,s.jsx)(r.code,{children:"/etc/rancher/rke2/config.yaml"})]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:'server: https://<VIP>:9345\ntoken: "<your-cluster-token>"\ntls-san:\n  - <VIP>\n  - <LB-domain>\n'})}),"\n",(0,s.jsx)(r.h3,{id:"23-\u555f\u52d5-rke2-server",children:"2.3 \u555f\u52d5 RKE2 Server"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"systemctl enable rke2-server\nsystemctl start rke2-server\n"})}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"3-\u5b89\u88dd-worker-nodes",children:"3. \u5b89\u88dd Worker Nodes"}),"\n",(0,s.jsx)(r.h3,{id:"31-\u5b89\u88dd-agent",children:"3.1 \u5b89\u88dd Agent"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'curl -sL https://get.rke2.io | INSTALL_RKE2_TYPE="agent" sh\n'})}),"\n",(0,s.jsx)(r.h3,{id:"32-\u5efa\u7acb-worker-\u8a2d\u5b9a\u6a94",children:"3.2 \u5efa\u7acb Worker \u8a2d\u5b9a\u6a94"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.code,{children:"/etc/rancher/rke2/config.yaml"}),"\uff1a"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:'server: https://<VIP>:9345\ntoken: "<your-token>"\n'})}),"\n",(0,s.jsx)(r.h3,{id:"33-\u555f\u52d5-agent",children:"3.3 \u555f\u52d5 agent"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"systemctl enable rke2-agent\nsystemctl start rke2-agent\n"})}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"4-load-balancerhaproxy--keepalived",children:"4. Load Balancer\uff08HAProxy / Keepalived\uff09"}),"\n",(0,s.jsx)(r.h3,{id:"41-keepalived\u63d0\u4f9b-vip",children:"4.1 Keepalived\uff08\u63d0\u4f9b VIP\uff09"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-conf",children:"vrrp_instance VI_1 {\n  state MASTER\n  interface eth0\n  virtual_router_id 55\n  priority 200\n  advert_int 1\n  virtual_ipaddress {\n    192.168.1.100\n  }\n}\n"})}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h3,{id:"42-haproxy\u8f49\u767c-6443--9345",children:"4.2 HAProxy\uff08\u8f49\u767c 6443 / 9345\uff09"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-conf",children:"frontend k8s_api\n  bind *:6443\n  default_backend k8s_api_backend\n\nbackend k8s_api_backend\n  balance roundrobin\n  server cp-1 192.168.1.10:6443 check\n  server cp-2 192.168.1.20:6443 check\n  server cp-3 192.168.1.30:6443 check\n\nfrontend supervisor\n  bind *:9345\n  default_backend supervisor_backend\n\nbackend supervisor_backend\n  balance roundrobin\n  server cp-1 192.168.1.10:9345 check\n  server cp-2 192.168.1.20:9345 check\n  server cp-3 192.168.1.30:9345 check\n"})}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"5-\u9a57\u8b49\u53e2\u96c6\u72c0\u614b",children:"5. \u9a57\u8b49\u53e2\u96c6\u72c0\u614b"}),"\n",(0,s.jsx)(r.h3,{id:"51-\u6aa2\u67e5\u7bc0\u9ede",children:"5.1 \u6aa2\u67e5\u7bc0\u9ede"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl get nodes -o wide\n"})}),"\n",(0,s.jsx)(r.h3,{id:"52-\u6aa2\u67e5\u6240\u6709-pod",children:"5.2 \u6aa2\u67e5\u6240\u6709 Pod"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl get pods -A\n"})}),"\n",(0,s.jsx)(r.h3,{id:"53-\u6aa2\u67e5-etcd-\u6210\u54e1",children:"5.3 \u6aa2\u67e5 etcd \u6210\u54e1"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"/var/lib/rancher/rke2/bin/etcdctl   --cacert=/var/lib/rancher/rke2/server/tls/etcd/server-ca.crt   --cert=/var/lib/rancher/rke2/server/tls/etcd/server.crt   --key=/var/lib/rancher/rke2/server/tls/etcd/server.key   member list\n"})}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"6-troubleshooting\u5e38\u898b\u554f\u984c\u6392\u67e5",children:"6. Troubleshooting\uff08\u5e38\u898b\u554f\u984c\u6392\u67e5\uff09"}),"\n",(0,s.jsxs)(r.h3,{id:"\u554f\u984c-1connection-refused-1270012379",children:["\u554f\u984c 1\uff1a",(0,s.jsx)(r.code,{children:"connection refused 127.0.0.1:2379"})]}),"\n",(0,s.jsxs)(r.p,{children:["\u539f\u56e0\uff1aetcd \u5c1a\u672a\u555f\u52d5",(0,s.jsx)(r.br,{}),"\n","\u67e5\u770b\uff1a"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"journalctl -u rke2-server -f\n"})}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsxs)(r.h3,{id:"\u554f\u984c-2x509-certificate-is-valid-for--not-vip",children:["\u554f\u984c 2\uff1a",(0,s.jsx)(r.code,{children:"x509: certificate is valid for ... not VIP"})]}),"\n",(0,s.jsx)(r.p,{children:"\u52a0\u5165\uff1a"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"tls-san:\n  - <VIP>\n"})}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h3,{id:"\u554f\u984c-3worker-\u7121\u6cd5\u52a0\u5165",children:"\u554f\u984c 3\uff1aWorker \u7121\u6cd5\u52a0\u5165"}),"\n",(0,s.jsxs)(r.p,{children:["LB \u5fc5\u9808\u540c\u6642\u8655\u7406 ",(0,s.jsx)(r.strong,{children:"6443"})," \u8207 ",(0,s.jsx)(r.strong,{children:"9345"}),"\u3002"]}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h3,{id:"\u554f\u984c-4etcd-quorum-lost",children:"\u554f\u984c 4\uff1aetcd quorum lost"}),"\n",(0,s.jsx)(r.p,{children:"\u4e09\u53f0 control-plane \u81f3\u5c11\u8981\u6d3b\u8457\u5169\u53f0\u3002"}),"\n",(0,s.jsx)(r.p,{children:"\u6aa2\u67e5\uff1a"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"etcdctl endpoint health\n"})}),"\n",(0,s.jsx)(r.h1,{id:"\u53c3\u8003\u6587\u4ef6",children:"\u53c3\u8003\u6587\u4ef6"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.a,{href:"https://docs.rke2.io/install/quickstart",children:"RKE2 Quickstart\uff08\u5b98\u65b9\u6587\u4ef6\uff09"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.a,{href:"https://docs.rke2.io/install/ha",children:"RKE2 HA\uff08\u5b98\u65b9\u6587\u4ef6\uff09"})}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,d.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}}}]);