"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[142],{28127:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>p,frontMatter:()=>s,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"auth/openfga/openfga-authorization-architecture","title":"Enterprise Authorization Architecture","description":"Designing organization structure and form permissions with OpenFGA, integrated with Zitadel and Cerbos","source":"@site/docs/auth/03-openfga/enterprise-authorization.md","sourceDirName":"auth/03-openfga","slug":"/authorization/openfga-architecture","permalink":"/en/docs/authorization/openfga-architecture","draft":false,"unlisted":false,"editUrl":"https://github.com/rhincodon-studio/my-website/tree/main/docs/auth/03-openfga/enterprise-authorization.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"id":"openfga-authorization-architecture","title":"Enterprise Authorization Architecture","sidebar_label":"Enterprise Authorization","description":"Designing organization structure and form permissions with OpenFGA, integrated with Zitadel and Cerbos","slug":"/authorization/openfga-architecture","sidebar_position":1,"author":"balnibarbian"},"sidebar":"tutorialSidebar","previous":{"title":"OpenFGA","permalink":"/en/docs/category/openfga"},"next":{"title":"DAPR","permalink":"/en/docs/category/dapr"}}');var d=r(74848),t=r(28453);const s={id:"openfga-authorization-architecture",title:"Enterprise Authorization Architecture",sidebar_label:"Enterprise Authorization",description:"Designing organization structure and form permissions with OpenFGA, integrated with Zitadel and Cerbos",slug:"/authorization/openfga-architecture",sidebar_position:1,author:"balnibarbian"},a=void 0,l={},o=[{value:"\u7cfb\u7d71\u8077\u8cac\u5206\u96e2",id:"\u7cfb\u7d71\u8077\u8cac\u5206\u96e2",level:2},{value:"\u7d44\u7e54\u67b6\u69cb\u8a2d\u8a08",id:"\u7d44\u7e54\u67b6\u69cb\u8a2d\u8a08",level:2},{value:"\u7d44\u7e54\u5c64\u7d1a\u95dc\u4fc2",id:"\u7d44\u7e54\u5c64\u7d1a\u95dc\u4fc2",level:3},{value:"OpenFGA Model \u5b9a\u7fa9",id:"openfga-model-\u5b9a\u7fa9",level:3},{value:"\u8cc7\u6599\u5c0d\u7167\u8868",id:"\u8cc7\u6599\u5c0d\u7167\u8868",level:3},{value:"\u5730\u7406\u5c64\u7d1a\u8a2d\u8a08",id:"\u5730\u7406\u5c64\u7d1a\u8a2d\u8a08",level:2},{value:"\u8868\u55ae\u6b0a\u9650\u8a2d\u8a08",id:"\u8868\u55ae\u6b0a\u9650\u8a2d\u8a08",level:2},{value:"\u8868\u55ae\u95dc\u4fc2\u6a21\u578b",id:"\u8868\u55ae\u95dc\u4fc2\u6a21\u578b",level:3},{value:"\u8868\u55ae Model \u5b9a\u7fa9",id:"\u8868\u55ae-model-\u5b9a\u7fa9",level:3},{value:"\u6b0a\u9650\u77e9\u9663",id:"\u6b0a\u9650\u77e9\u9663",level:3},{value:"\u540c\u6b65\u7a0b\u5f0f\u5be6\u4f5c",id:"\u540c\u6b65\u7a0b\u5f0f\u5be6\u4f5c",level:2},{value:"OrgTree \u540c\u6b65",id:"orgtree-\u540c\u6b65",level:3},{value:"\u8868\u55ae\u540c\u6b65",id:"\u8868\u55ae\u540c\u6b65",level:3},{value:"Zitadel \u6574\u5408",id:"zitadel-\u6574\u5408",level:2},{value:"\u5efa\u8b70\u8a2d\u5b9a",id:"\u5efa\u8b70\u8a2d\u5b9a",level:3},{value:"\u6b0a\u9650\u6aa2\u67e5\u6d41\u7a0b",id:"\u6b0a\u9650\u6aa2\u67e5\u6d41\u7a0b",level:3},{value:"API \u5be6\u4f5c",id:"api-\u5be6\u4f5c",level:3},{value:"Cerbos \u7684\u5b9a\u4f4d",id:"cerbos-\u7684\u5b9a\u4f4d",level:2},{value:"\u8207 OpenFGA \u7684\u5dee\u7570",id:"\u8207-openfga-\u7684\u5dee\u7570",level:3},{value:"\u8207 Camunda DMN \u7684\u6bd4\u8f03",id:"\u8207-camunda-dmn-\u7684\u6bd4\u8f03",level:3},{value:"\u4f55\u6642\u9700\u8981 Cerbos",id:"\u4f55\u6642\u9700\u8981-cerbos",level:3},{value:"\u6574\u5408\u4f7f\u7528",id:"\u6574\u5408\u4f7f\u7528",level:3},{value:"\u7e3d\u7d50",id:"\u7e3d\u7d50",level:2}];function c(e){const n={code:"code",h2:"h2",h3:"h3",mermaid:"mermaid",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,t.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.p,{children:"\u672c\u6587\u8aaa\u660e\u5982\u4f55\u4f7f\u7528 OpenFGA \u8a2d\u8a08\u4f01\u696d\u7d1a\u7684\u6b0a\u9650\u7cfb\u7d71\uff0c\u6db5\u84cb\u7d44\u7e54\u67b6\u69cb\u3001\u8868\u55ae\u6b0a\u9650\u3001\u591a\u5730\u5340\u7ba1\u7406\uff0c\u4e26\u8aaa\u660e\u5982\u4f55\u8207 Zitadel\u3001Cerbos \u642d\u914d\u4f7f\u7528\u3002"}),"\n",(0,d.jsx)(n.h2,{id:"\u7cfb\u7d71\u8077\u8cac\u5206\u96e2",children:"\u7cfb\u7d71\u8077\u8cac\u5206\u96e2"}),"\n",(0,d.jsx)(n.p,{children:"\u5728\u958b\u59cb\u4e4b\u524d\uff0c\u5148\u91d0\u6e05\u4e09\u500b\u7cfb\u7d71\u5404\u81ea\u8ca0\u8cac\u7684\u4e8b\u60c5\uff1a"}),"\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"\u7cfb\u7d71"}),(0,d.jsx)(n.th,{children:"\u8077\u8cac"}),(0,d.jsx)(n.th,{children:"\u6838\u5fc3\u554f\u984c"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"Zitadel"}),(0,d.jsx)(n.td,{children:"Authentication \u8a8d\u8b49"}),(0,d.jsx)(n.td,{children:"\u4f60\u662f\u8ab0\uff1f"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"OpenFGA"}),(0,d.jsx)(n.td,{children:"Authorization \u6388\u6b0a"}),(0,d.jsx)(n.td,{children:"\u4f60\u8ddf\u8cc7\u6e90\u7684\u95dc\u4fc2\uff1f"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"Cerbos"}),(0,d.jsx)(n.td,{children:"Policy \u689d\u4ef6\u5224\u65b7"}),(0,d.jsx)(n.td,{children:"\u4f60\u7b26\u5408\u689d\u4ef6\u55ce\uff1f"})]})]})]}),"\n",(0,d.jsx)(n.p,{children:"\u6574\u9ad4\u67b6\u69cb\u5982\u4e0b\uff1a"}),"\n",(0,d.jsx)(n.mermaid,{value:"graph LR\n    subgraph \u8a8d\u8b49\u5c64\n        Zitadel[Zitadel]\n    end\n    \n    subgraph \u6388\u6b0a\u5c64\n        OpenFGA[OpenFGA]\n        Cerbos[Cerbos]\n    end\n    \n    subgraph \u61c9\u7528\n        API[API Gateway]\n    end\n    \n    User --\x3e|1. \u767b\u5165\u53d6 Token| Zitadel\n    User --\x3e|2. \u8acb\u6c42| API\n    API --\x3e|3. \u95dc\u4fc2\u6aa2\u67e5| OpenFGA\n    API --\x3e|4. \u689d\u4ef6\u6aa2\u67e5| Cerbos"}),"\n",(0,d.jsx)(n.h2,{id:"\u7d44\u7e54\u67b6\u69cb\u8a2d\u8a08",children:"\u7d44\u7e54\u67b6\u69cb\u8a2d\u8a08"}),"\n",(0,d.jsx)(n.h3,{id:"\u7d44\u7e54\u5c64\u7d1a\u95dc\u4fc2",children:"\u7d44\u7e54\u5c64\u7d1a\u95dc\u4fc2"}),"\n",(0,d.jsx)(n.p,{children:"\u4f01\u696d\u7684 OrgTree \u901a\u5e38\u5305\u542b\u4ee5\u4e0b\u5c64\u7d1a\uff1a"}),"\n",(0,d.jsx)(n.mermaid,{value:"graph TD\n    subgraph \u7d44\u7e54\u5c64\u7d1a\n        BG[BG \u4e8b\u696d\u7fa4]\n        BU[BU \u4e8b\u696d\u55ae\u4f4d]\n        Dept[Department \u90e8\u9580]\n        SubDept[Department \u5b50\u90e8\u9580]\n        Emp[Employee \u54e1\u5de5]\n    end\n    \n    BU --\x3e|parent| BG\n    Dept --\x3e|parent| BU\n    SubDept --\x3e|parent| Dept\n    \n    Emp --\x3e|member_of| Dept\n    Emp --\x3e|manager_of| Dept\n    Emp --\x3e|reports_to| Emp"}),"\n",(0,d.jsx)(n.h3,{id:"openfga-model-\u5b9a\u7fa9",children:"OpenFGA Model \u5b9a\u7fa9"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:"model\n  schema 1.1\n\ntype employee\n  relations\n    define reports_to: [employee]\n    define supervisor: reports_to or supervisor from reports_to\n\ntype bg\n  relations\n    define admin: [employee]\n    define member: [employee] or admin or member from child_bu\n    \ntype bu\n  relations\n    define parent: [bg]\n    define admin: [employee] or admin from parent\n    define member: [employee] or admin or member from child_dept\n    define bg_admin: admin from parent\n\ntype department\n  relations\n    define parent_bu: [bu]\n    define parent_dept: [department]\n    define manager: [employee]\n    define direct_member: [employee]\n    define member: direct_member or manager or member from child_dept\n    define admin: manager or admin from parent_bu or admin from parent_dept\n    define can_view: member or admin\n"})}),"\n",(0,d.jsx)(n.h3,{id:"\u8cc7\u6599\u5c0d\u7167\u8868",children:"\u8cc7\u6599\u5c0d\u7167\u8868"}),"\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"OrgTree \u6b04\u4f4d"}),(0,d.jsx)(n.th,{children:"OpenFGA \u95dc\u4fc2"}),(0,d.jsx)(n.th,{children:"\u7bc4\u4f8b"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"BU.bg_id"}),(0,d.jsx)(n.td,{children:"bu \u2192 parent \u2192 bg"}),(0,d.jsxs)(n.td,{children:["bu",":mobile"," \u2192 bg",":consumer"]})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"Dept.bu_id"}),(0,d.jsx)(n.td,{children:"department \u2192 parent_bu \u2192 bu"}),(0,d.jsxs)(n.td,{children:["dept",":rd"," \u2192 bu",":mobile"]})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"Dept.parent_dept_id"}),(0,d.jsx)(n.td,{children:"department \u2192 parent_dept \u2192 department"}),(0,d.jsxs)(n.td,{children:["dept",":team_a"," \u2192 dept",":rd"]})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"Employee.dept_id"}),(0,d.jsx)(n.td,{children:"employee \u2192 direct_member \u2192 department"}),(0,d.jsxs)(n.td,{children:["alice \u2192 dept",":rd"]})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"Employee.is_manager"}),(0,d.jsx)(n.td,{children:"employee \u2192 manager \u2192 department"}),(0,d.jsxs)(n.td,{children:["alice \u2192 dept",":rd"]})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"Employee.manager_id"}),(0,d.jsx)(n.td,{children:"employee \u2192 reports_to \u2192 employee"}),(0,d.jsx)(n.td,{children:"bob \u2192 alice"})]})]})]}),"\n",(0,d.jsx)(n.h2,{id:"\u5730\u7406\u5c64\u7d1a\u8a2d\u8a08",children:"\u5730\u7406\u5c64\u7d1a\u8a2d\u8a08"}),"\n",(0,d.jsx)(n.p,{children:"\u9664\u4e86\u7d44\u7e54\u67b6\u69cb\uff0c\u8868\u55ae\u7cfb\u7d71\u901a\u5e38\u9084\u9700\u8981\u5730\u5340\u8207\u5ee0\u5340\u7684\u6982\u5ff5\uff1a"}),"\n",(0,d.jsx)(n.mermaid,{value:"graph TD\n    subgraph \u5730\u7406\u5c64\u7d1a\n        Region[Region \u5730\u5340]\n        Plant[Plant \u5ee0\u5340]\n    end\n    \n    Plant --\x3e|parent| Region"}),"\n",(0,d.jsx)(n.p,{children:"Model \u5b9a\u7fa9\uff1a"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:"type region\n  relations\n    define admin: [employee]\n    define member: [employee] or admin\n\ntype plant\n  relations\n    define parent: [region]\n    define admin: [employee] or admin from parent\n    define member: [employee] or admin\n    define region_admin: admin from parent\n"})}),"\n",(0,d.jsx)(n.h2,{id:"\u8868\u55ae\u6b0a\u9650\u8a2d\u8a08",children:"\u8868\u55ae\u6b0a\u9650\u8a2d\u8a08"}),"\n",(0,d.jsx)(n.h3,{id:"\u8868\u55ae\u95dc\u4fc2\u6a21\u578b",children:"\u8868\u55ae\u95dc\u4fc2\u6a21\u578b"}),"\n",(0,d.jsx)(n.p,{children:"\u4e00\u5f35\u8868\u55ae\u53ef\u80fd\u95dc\u806f\u5230\u591a\u500b\u5730\u5340\u3001\u591a\u500b\u5ee0\u5340\uff1a"}),"\n",(0,d.jsx)(n.mermaid,{value:"graph TD\n    subgraph \u5730\u5340\n        R1[Region \u53f0\u7063\u5317\u5340]\n        R2[Region \u53f0\u7063\u5357\u5340]\n        R3[Region \u83ef\u6771\u5340]\n    end\n    \n    subgraph \u8868\u55ae\n        Form[Form PR-2024-001]\n    end\n    \n    Form --\x3e|region| R1\n    Form --\x3e|region| R2\n    Form --\x3e|region| R3\n    Form --\x3e|creator| Emp[Employee]\n    Form --\x3e|approver| Emp2[Employee]"}),"\n",(0,d.jsx)(n.h3,{id:"\u8868\u55ae-model-\u5b9a\u7fa9",children:"\u8868\u55ae Model \u5b9a\u7fa9"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:"type form\n  relations\n    # \u57fa\u672c\u95dc\u4fc2\uff0c\u652f\u63f4\u591a\u5c0d\u591a\n    define region: [region]\n    define plant: [plant]\n    define creator: [employee]\n    define approver: [employee]\n    \n    # \u6b0a\u9650\u63a8\u5c0e\n    define plant_admin: admin from plant\n    define region_admin: admin from region\n    define creator_supervisor: supervisor from creator\n    \n    # \u6700\u7d42\u6b0a\u9650\n    define can_view: creator or approver or plant_admin or region_admin or creator_supervisor\n    define can_edit: creator or plant_admin\n    define can_approve: [employee] but not creator\n"})}),"\n",(0,d.jsx)(n.h3,{id:"\u6b0a\u9650\u77e9\u9663",children:"\u6b0a\u9650\u77e9\u9663"}),"\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"\u89d2\u8272"}),(0,d.jsx)(n.th,{children:"can_view"}),(0,d.jsx)(n.th,{children:"can_edit"}),(0,d.jsx)(n.th,{children:"can_approve"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u958b\u55ae\u4eba\u54e1"}),(0,d.jsx)(n.td,{children:"\u2713"}),(0,d.jsx)(n.td,{children:"\u2713"}),(0,d.jsx)(n.td,{children:"\u2717"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u5df2\u7c3d\u6838\u4eba\u54e1"}),(0,d.jsx)(n.td,{children:"\u2713"}),(0,d.jsx)(n.td,{children:"\u2717"}),(0,d.jsx)(n.td,{children:"\u2717"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u5f85\u7c3d\u6838\u4eba\u54e1"}),(0,d.jsx)(n.td,{children:"\u2713"}),(0,d.jsx)(n.td,{children:"\u2717"}),(0,d.jsx)(n.td,{children:"\u2713"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u958b\u55ae\u4eba\u4e3b\u7ba1\u93c8"}),(0,d.jsx)(n.td,{children:"\u2713"}),(0,d.jsx)(n.td,{children:"\u2717"}),(0,d.jsx)(n.td,{children:"\u8996\u898f\u5247"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u5ee0\u5340\u7ba1\u7406\u8005"}),(0,d.jsx)(n.td,{children:"\u2713"}),(0,d.jsx)(n.td,{children:"\u2713"}),(0,d.jsx)(n.td,{children:"\u8996\u898f\u5247"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u5730\u5340\u7ba1\u7406\u8005"}),(0,d.jsx)(n.td,{children:"\u2713"}),(0,d.jsx)(n.td,{children:"\u2717"}),(0,d.jsx)(n.td,{children:"\u8996\u898f\u5247"})]})]})]}),"\n",(0,d.jsx)(n.h2,{id:"\u540c\u6b65\u7a0b\u5f0f\u5be6\u4f5c",children:"\u540c\u6b65\u7a0b\u5f0f\u5be6\u4f5c"}),"\n",(0,d.jsx)(n.h3,{id:"orgtree-\u540c\u6b65",children:"OrgTree \u540c\u6b65"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-python",children:'class OrgTreeSyncer:\n    def __init__(self, fga_client):\n        self.fga = fga_client\n    \n    def sync_bu(self, bu):\n        self.fga.write(\n            user=f"bu:{bu.id}",\n            relation="parent",\n            object=f"bg:{bu.bg_id}"\n        )\n    \n    def sync_department(self, dept):\n        if dept.parent_dept_id:\n            self.fga.write(\n                user=f"department:{dept.id}",\n                relation="parent_dept",\n                object=f"department:{dept.parent_dept_id}"\n            )\n        else:\n            self.fga.write(\n                user=f"department:{dept.id}",\n                relation="parent_bu",\n                object=f"bu:{dept.bu_id}"\n            )\n    \n    def sync_employee(self, emp):\n        self.fga.write(\n            user=f"employee:{emp.id}",\n            relation="direct_member",\n            object=f"department:{emp.dept_id}"\n        )\n        \n        if emp.is_manager:\n            self.fga.write(\n                user=f"employee:{emp.id}",\n                relation="manager",\n                object=f"department:{emp.dept_id}"\n            )\n        \n        if emp.manager_id:\n            self.fga.write(\n                user=f"employee:{emp.id}",\n                relation="reports_to",\n                object=f"employee:{emp.manager_id}"\n            )\n'})}),"\n",(0,d.jsx)(n.h3,{id:"\u8868\u55ae\u540c\u6b65",children:"\u8868\u55ae\u540c\u6b65"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-python",children:'def create_form_tuples(form):\n    tuples = []\n    \n    for region_id in form.region_ids:\n        tuples.append({\n            "user": f"region:{region_id}",\n            "relation": "region",\n            "object": f"form:{form.id}"\n        })\n    \n    for plant_id in form.plant_ids:\n        tuples.append({\n            "user": f"plant:{plant_id}",\n            "relation": "plant",\n            "object": f"form:{form.id}"\n        })\n    \n    tuples.append({\n        "user": f"employee:{form.creator_id}",\n        "relation": "creator",\n        "object": f"form:{form.id}"\n    })\n    \n    return tuples\n\n\ndef on_approval_complete(form_id, approver_id):\n    fga.write(\n        user=f"employee:{approver_id}",\n        relation="approver",\n        object=f"form:{form_id}"\n    )\n'})}),"\n",(0,d.jsx)(n.h2,{id:"zitadel-\u6574\u5408",children:"Zitadel \u6574\u5408"}),"\n",(0,d.jsx)(n.h3,{id:"\u5efa\u8b70\u8a2d\u5b9a",children:"\u5efa\u8b70\u8a2d\u5b9a"}),"\n",(0,d.jsx)(n.p,{children:"Zitadel \u8ca0\u8cac\u8a8d\u8b49\uff0c\u6b0a\u9650\u4ea4\u7d66 OpenFGA\uff0c\u56e0\u6b64 Zitadel \u8a2d\u5b9a\u53ef\u4ee5\u7c21\u5316\uff1a"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:"Organization: default\nProject: your-app\nRoles:\n  - user\n  - admin\n"})}),"\n",(0,d.jsx)(n.h3,{id:"\u6b0a\u9650\u6aa2\u67e5\u6d41\u7a0b",children:"\u6b0a\u9650\u6aa2\u67e5\u6d41\u7a0b"}),"\n",(0,d.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant User\n    participant App\n    participant Zitadel\n    participant OpenFGA\n    \n    User->>Zitadel: \u767b\u5165\n    Zitadel->>User: JWT Token\n    User->>App: \u8acb\u6c42\u67e5\u770b\u8868\u55ae\n    App->>App: \u5f9e JWT \u53d6\u5f97 user_id\n    App->>OpenFGA: check employee:user_id can_view form:id\n    OpenFGA->>App: allowed: true/false\n    App->>User: \u56de\u50b3\u7d50\u679c"}),"\n",(0,d.jsx)(n.h3,{id:"api-\u5be6\u4f5c",children:"API \u5be6\u4f5c"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-python",children:'from fastapi import Depends, HTTPException\n\nasync def check_form_permission(\n    form_id: str,\n    permission: str,\n    current_user: User = Depends(get_current_user)\n):\n    allowed = await fga.check(\n        user=f"employee:{current_user.id}",\n        relation=permission,\n        object=f"form:{form_id}"\n    )\n    \n    if not allowed:\n        raise HTTPException(status_code=403, detail="Permission denied")\n\n\n@app.get("/forms/{form_id}")\nasync def get_form(\n    form_id: str,\n    _: None = Depends(lambda: check_form_permission(form_id, "can_view"))\n):\n    return await form_service.get(form_id)\n'})}),"\n",(0,d.jsx)(n.h2,{id:"cerbos-\u7684\u5b9a\u4f4d",children:"Cerbos \u7684\u5b9a\u4f4d"}),"\n",(0,d.jsx)(n.h3,{id:"\u8207-openfga-\u7684\u5dee\u7570",children:"\u8207 OpenFGA \u7684\u5dee\u7570"}),"\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"\u9805\u76ee"}),(0,d.jsx)(n.th,{children:"OpenFGA"}),(0,d.jsx)(n.th,{children:"Cerbos"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u6a21\u578b"}),(0,d.jsx)(n.td,{children:"ReBAC \u95dc\u4fc2\u578b"}),(0,d.jsx)(n.td,{children:"PBAC \u653f\u7b56\u578b"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u6838\u5fc3\u554f\u984c"}),(0,d.jsx)(n.td,{children:"A \u548c B \u6709\u4ec0\u9ebc\u95dc\u4fc2\uff1f"}),(0,d.jsx)(n.td,{children:"A \u7b26\u5408\u4ec0\u9ebc\u689d\u4ef6\uff1f"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u8cc7\u6599\u5132\u5b58"}),(0,d.jsx)(n.td,{children:"\u5132\u5b58\u95dc\u4fc2 tuple"}),(0,d.jsx)(n.td,{children:"\u4e0d\u5132\u5b58\uff0c\u5373\u6642\u904b\u7b97"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u9069\u5408\u5834\u666f"}),(0,d.jsx)(n.td,{children:"\u7d44\u7e54\u67b6\u69cb\u3001\u6587\u4ef6\u5354\u4f5c"}),(0,d.jsx)(n.td,{children:"\u5c6c\u6027\u689d\u4ef6\u3001\u5546\u696d\u898f\u5247"})]})]})]}),"\n",(0,d.jsx)(n.h3,{id:"\u8207-camunda-dmn-\u7684\u6bd4\u8f03",children:"\u8207 Camunda DMN \u7684\u6bd4\u8f03"}),"\n",(0,d.jsx)(n.p,{children:"Cerbos \u672c\u8cea\u4e0a\u985e\u4f3c\u65bc\u5c08\u9580\u7528\u65bc\u6b0a\u9650\u5224\u65b7\u7684 DMN\uff1a"}),"\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{}),(0,d.jsx)(n.th,{children:"DMN"}),(0,d.jsx)(n.th,{children:"Cerbos"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u554f\u984c"}),(0,d.jsx)(n.td,{children:"\u7d50\u679c\u662f\u4ec0\u9ebc\uff1f"}),(0,d.jsx)(n.td,{children:"\u53ef\u4e0d\u53ef\u4ee5\uff1f"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u8f38\u51fa"}),(0,d.jsx)(n.td,{children:"\u591a\u5143"}),(0,d.jsx)(n.td,{children:"\u4e8c\u5143"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u7528\u9014"}),(0,d.jsx)(n.td,{children:"\u901a\u7528\u5546\u696d\u898f\u5247"}),(0,d.jsx)(n.td,{children:"\u5c08\u6ce8\u6388\u6b0a"})]})]})]}),"\n",(0,d.jsx)(n.h3,{id:"\u4f55\u6642\u9700\u8981-cerbos",children:"\u4f55\u6642\u9700\u8981 Cerbos"}),"\n",(0,d.jsx)(n.p,{children:"\u7576\u4f60\u7684\u6b0a\u9650\u908f\u8f2f\u9700\u8981\u57fa\u65bc\u5c6c\u6027\u689d\u4ef6\u5224\u65b7\u6642\uff1a"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:'# Cerbos Policy \u7bc4\u4f8b\napiVersion: api.cerbos.dev/v1\nresourcePolicy:\n  version: default\n  resource: form\n  rules:\n    - actions: ["edit"]\n      effect: EFFECT_ALLOW\n      roles: ["user"]\n      condition:\n        match:\n          all:\n            - expr: request.resource.attr.creator_id == request.principal.id\n            - expr: request.resource.attr.status == "draft"\n    \n    - actions: ["approve"]\n      effect: EFFECT_ALLOW\n      roles: ["director", "vp", "ceo"]\n      condition:\n        match:\n          expr: request.resource.attr.amount > 1000000\n'})}),"\n",(0,d.jsx)(n.h3,{id:"\u6574\u5408\u4f7f\u7528",children:"\u6574\u5408\u4f7f\u7528"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-python",children:'async def check_permission(user, action, form):\n    # Step 1: OpenFGA \u6aa2\u67e5\u95dc\u4fc2\n    has_relationship = await openfga.check(\n        user=f"employee:{user.id}",\n        relation=f"can_{action}",\n        object=f"form:{form.id}"\n    )\n    \n    if not has_relationship:\n        return False\n    \n    # Step 2: Cerbos \u6aa2\u67e5\u689d\u4ef6\n    decision = await cerbos.check(\n        principal={"id": user.id, "roles": user.roles},\n        resource={"kind": "form", "id": form.id, "attr": {\n            "status": form.status,\n            "amount": form.amount\n        }},\n        action=action\n    )\n    \n    return decision.is_allowed()\n'})}),"\n",(0,d.jsx)(n.h2,{id:"\u7e3d\u7d50",children:"\u7e3d\u7d50"}),"\n",(0,d.jsx)(n.p,{children:"\u6839\u64da\u9700\u6c42\u9078\u64c7\u9069\u5408\u7684\u7d44\u5408\uff1a"}),"\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"\u9700\u6c42"}),(0,d.jsx)(n.th,{children:"\u5efa\u8b70\u65b9\u6848"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u53ea\u9700\u8981\u95dc\u4fc2\u578b\u6b0a\u9650"}),(0,d.jsx)(n.td,{children:"Zitadel + OpenFGA"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u9700\u8981\u689d\u4ef6\u5224\u65b7"}),(0,d.jsx)(n.td,{children:"Zitadel + OpenFGA + Cerbos"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u9700\u8981\u6c7a\u7b56\u5f15\u64ce"}),(0,d.jsx)(n.td,{children:"\u52a0\u5165 Camunda DMN"})]})]})]}),"\n",(0,d.jsx)(n.p,{children:"\u5c0d\u65bc\u5927\u591a\u6578\u8868\u55ae\u7cfb\u7d71\uff0cZitadel + OpenFGA \u5df2\u7d93\u8db3\u5920\u3002\u7b49\u5230\u6709\u660e\u78ba\u7684\u689d\u4ef6\u5224\u65b7\u9700\u6c42\u6642\uff0c\u518d\u52a0\u5165 Cerbos \u4e5f\u4e0d\u9072\u3002"})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(c,{...e})}):c(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>a});var i=r(96540);const d={},t=i.createContext(d);function s(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:s(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);